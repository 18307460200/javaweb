# 网站的安全架构

<!-- TOC depthFrom:2 depthTo:3 -->

- [1. 网站安全的攻与防](#1-网站安全的攻与防)
    - [1.1. XSS 攻击](#11-xss-攻击)
    - [1.2. 注入攻击](#12-注入攻击)
    - [1.3. CSRF 攻击](#13-csrf-攻击)
- [2. 加密技术及密钥安全管理](#2-加密技术及密钥安全管理)
    - [2.1. 消息摘要](#21-消息摘要)
    - [2.2. 对称加密](#22-对称加密)
    - [2.3. 非对称加密](#23-非对称加密)
    - [2.4. 密钥安全管理](#24-密钥安全管理)
- [3. 资料](#3-资料)

<!-- /TOC -->

## 1. 网站安全的攻与防

### 1.1. XSS 攻击

XSS 攻击即跨站点脚本攻击（Cross Site Script），指黑客通过篡改网页，注入恶意 HTML 脚本，在用户浏览网页时，控制用户浏览器进行恶意操作的一种攻击方式。

XSS 攻击有两种类型：

（1）反射型 XSS 攻击

<div align="center">
<img src="https://raw.githubusercontent.com/dunwu/JavaWeb/master/images/architecture/安全-反射型XSS攻击.png" width="640" />
</div>

（2）持久型 XSS 攻击

<div align="center">
<img src="https://raw.githubusercontent.com/dunwu/JavaWeb/master/images/architecture/安全-持久型XSS攻击.png" width="640" />
</div>

应对手段：

- **消毒** - XSS 攻击一般是通过在请求中嵌入恶意脚本达到攻击的目的，这些脚本是一般用户输入中不使用的。过滤和消毒处理，即对某些 html 危险字符转移，如 `>` 转义为 `&gt`、`<` 转义为 `&lt` 等，就可以防止大部分攻击。为了避免对不必要的内容错误转移，如 `3<5` 中的 `<` 需要进行文本匹配后再转移，如：`<img src=` 这样的上下文中的 `<` 才转义。
- **HttpOnly** - 由微软提出，即浏览器禁止页面 JavaScript 访问带有 HttpOnly 属性的 Cookie。HttpOnly 并不是直接对抗 XSS 攻击的，而是防止 XSS 攻击者窃取 Cookie。对于存放敏感信息的 Cookie，如用户认证信息等，可以通过对该 Cookie 添加 HttpOnly 属性，避免被攻击脚本窃取。

### 1.2. 注入攻击

注入攻击主要有两种形式，SQL 注入攻击和 OS 注入攻击。

攻击者在 HTTP 请求中注入恶意 SQL 命令，服务器用请求参数构造数据库 SQL 命令时，恶意 SQL 被一起构造，并在数据库中执行。

<div align="center">
<img src="https://raw.githubusercontent.com/dunwu/JavaWeb/master/images/architecture/安全-SQL注入攻击.png" width="500" />
</div>

应对手段：

- **消毒** - 和防 XSS 攻击一样，请求参数消毒是一种比较简单粗暴又有效的手段。通过正则匹配，过滤请求数据中可能注入的 SQL。
- **参数绑定** - 使用预编译手段，绑定参数是最好的防 SQL 注入方式。目前许多数据访问层框架，如 mybatis、hibernate 等，都实现 SQL 预编译和参数绑定，攻击者的恶意 SQL 会被当做 SQL 的参数，而不是 SQL 命令被执行。

### 1.3. CSRF 攻击

CSRF 攻击即跨站点请求伪造（Cross Site Request Forgery），攻击者通过跨站请求，以合法用户的身份进行非法操作，如转账交易、发表评论等。CSRF 的主要手法是利用跨站请求，在用户不知情的情况下，以用户身份伪造请求。其核心是利用了浏览器 Cookie 或服务器 Session 策略，盗取用户身份。

<div align="center">
<img src="https://raw.githubusercontent.com/dunwu/JavaWeb/master/images/architecture/安全-CSRF攻击.png" width="500" />
</div>

应对手段：

- **表单 Token** - CSRF 是一个伪造用户请求的操作，所以需要构造用户请求的所有参数才可以。表单 Token 通过在请求参数中添加随机数的办法来组织攻击者获得所有请求参数。
- **验证码** - 请求提交是，需要用户输入验证码，以避免用户在不知情的情况下被攻击者伪造请求。
- **Referer check** - HTTP 请求头的 Referer 域中记录着请求资源，可通过检查请求来源，验证其是否合法。

## 2. 加密技术及密钥安全管理

### 2.1. 消息摘要

常用数字签名算法：MD5、SHA 等。

应用场景：将用户密码以消息摘要形式保存到数据库中。

### 2.2. 对称加密

对称加密指加密和解密所使用的密钥是同一个密钥。

常用对称加密算法：DES 等。

应用场景：Cookie 加密、通信机密等。

### 2.3. 非对称加密

非对称加密指加密和解密所使用的不是同一个密钥，而是一个公私钥对。用公钥加密的信息必须用私钥才能解开；反之，用私钥加密的信息只有用公钥才能解开。

常用非对称加密算法：RSA 等。

应用场景：HTTPS 传输中浏览器使用的数字证书实质上是经过权威机构认证的非对称加密公钥。

### 2.4. 密钥安全管理

保证密钥安全的方法：

1.  把密钥和算法放在一个独立的服务器上，对外提供加密和解密服务，应用系统通过调用这个服务，实现数据的加解密。
2.  把加解密算法放在应用系统中，密钥则放在独立服务器中，为了提高密钥的安全性，实际存储时，密钥被切分成数片，加密后分别保存在不同存储介质中。

## 3. 资料

- [大型网站技术架构](https://item.jd.com/11322972.html)
